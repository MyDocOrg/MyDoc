name: Monorepo CI/CD

on:
  push:
    branches: [dev, main]

jobs:
  # ------------------------------------------------
  # Detect changes per service
  # ------------------------------------------------
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      auth-backend: ${{ steps.filter.outputs.auth-backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      mobile: ${{ steps.filter.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth-backend:
              - auth-backend/**
            backend:
              - backend/**
            frontend:
              - frontend/**
            mobile:
              - mobile/**

  # ------------------------------------------------
  # TEST AUTH IDENTITY API (.NET)
  # ------------------------------------------------
  test-auth-identity-api:
    needs: changes
    if: needs.changes.outputs.auth-backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
      - run: dotnet restore auth-backend
      - run: dotnet build auth-backend --configuration Release --no-restore
      - run: dotnet test auth-backend --no-build --verbosity normal

  # ------------------------------------------------
  # TEST MYDOC API (.NET)
  # ------------------------------------------------
  test-mydoc-api:
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
      - run: dotnet restore backend
      - run: dotnet build backend --configuration Release --no-restore
      - run: dotnet test backend --no-build --verbosity normal

  # ------------------------------------------------
  # BUILD & PUSH MYDOC API IMAGE
  # ------------------------------------------------
  build-mydoc-api:
    needs: [changes, test-mydoc-api]
    if: needs.changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login GHCR
        run: echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
      - name: Build image
        run: docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/mydoc-api:${{ github.sha }} -f ./backend/MyDoc/Dockerfile ./backend
      - name: Push image
        run: docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/mydoc-api:${{ github.sha }}

  # ------------------------------------------------
  # BUILD & PUSH AUTH IDENTITY API IMAGE
  # ------------------------------------------------
  build-auth-identity-api:
    needs: [changes, test-auth-identity-api]
    if: needs.changes.outputs.auth-backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login GHCR
        run: echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
      - name: Build image
        run: docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/auth-identity-api:${{ github.sha }} -f ./auth-backend/auth-backend/Dockerfile ./auth-backend/auth-backend
      - name: Push image
        run: docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/auth-identity-api:${{ github.sha }}

  # ------------------------------------------------
  # DEPLOY MYDOC API → Azure App Service
  # ------------------------------------------------
  deploy-mydoc-api:
    needs: build-mydoc-api
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure registry auth
        run: |
          az webapp config container set \
            --name mydoc-api \
            --resource-group MyDocRG \
            --docker-registry-server-url https://ghcr.io \
            --docker-registry-server-user ${{ secrets.GHCR_USERNAME }} \
            --docker-registry-server-password ${{ secrets.GHCR_PAT }}

      - name: Set container image
        run: |
          az webapp config container set \
            --name mydoc-api \
            --resource-group MyDocRG \
            --docker-custom-image-name ghcr.io/${{ secrets.GHCR_USERNAME }}/mydoc-api:${{ github.sha }} \
            --docker-registry-server-url https://ghcr.io

      - name: Restart app
        run: az webapp restart --name mydoc-api --resource-group MyDocRG

# ------------------------------------------------
# DEPLOY AUTH IDENTITY API → Azure App Service
# ------------------------------------------------
  deploy-auth-identity-api:
    needs: build-auth-identity-api
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure registry auth
        run: |
          az webapp config container set \
            --name auth-identity-api \
            --resource-group MyDocRG \
            --docker-registry-server-url https://ghcr.io \
            --docker-registry-server-user ${{ secrets.GHCR_USERNAME }} \
            --docker-registry-server-password ${{ secrets.GHCR_PAT }}
      
      - name: Set container image
        run: |
          az webapp config container set \
            --name auth-identity-api \
            --resource-group MyDocRG \
            --docker-custom-image-name ghcr.io/${{ secrets.GHCR_USERNAME }}/auth-identity-api:${{ github.sha }} \
            --docker-registry-server-url https://ghcr.io

      - name: Restart app
        run: az webapp restart --name auth-identity-api --resource-group MyDocRG

  # ------------------------------------------------
  # FRONTEND (Angular)
  # ------------------------------------------------
  frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: |
          cd frontend
          npm ci
          npm run build -- --configuration production

  # ------------------------------------------------
  # MOBILE (Flutter)
  # ------------------------------------------------
  mobile:
    needs: changes
    if: needs.changes.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: "stable"
      - run: |
          cd mobile
          flutter pub get
          flutter build apk --debug